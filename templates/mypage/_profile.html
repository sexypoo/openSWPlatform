<div class="section-wrapper">

    <h2 class="section-title">회원정보</h2>

    <div class="profile-card">

        <div id="view-mode">
            <div class="info-item">
                <label>아이디</label>
                <div class="info-display">{{ user.id }}</div>
            </div>

            <div class="info-item">
                <label>비밀번호</label>
                <div class="info-display">********</div>
            </div>

            <div class="info-item">
                <label>이메일</label>
                <div class="info-display">{{ user.email }}</div>
            </div>

            <button onclick="toggleEditMode()" class="primary-btn">
                회원정보 수정하기
            </button>
        </div>

        <div id="edit-mode" style="display:none;">
            <form method="post" action="{{ url_for('user.update_profile') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="info-item">
                    <label>아이디</label>
                    <div class="readonly-field">{{ user.id }}</div>
                </div>

                <div class="info-item">
                    <label>새 비밀번호 입력</label>
                    <input type="password" name="password_new" id="edit-password-new">
                    <p id="pw-warning" style="color:red; font-size:13px; margin-top:6px; display:none;">
                    현재 비밀번호와 동일합니다. 
                    </p> 
                </div>

                <div class="info-item">
                    <label>이메일</label>
                    <input type="email" name="email" value="{{ user.email }}">
                </div>

                <div class="button-group">
                    <button type="submit" class="save-btn" id="save-btn">저장하기</button>
                    <button type="button" onclick="cancelEdit()" class="cancel-btn">취소</button>
                </div>

            </form>
        </div>

    </div>

</div>

<div style="display: none;" class="!border-red-500 !text-red-900 !focus:border-red-500 !focus:ring-red-500 !placeholder-red-300"></div>

{% block script %}
<script>
    // 1. 토글 및 취소 함수
    function toggleEditMode() {
        const viewMode = document.getElementById("view-mode");
        const editMode = document.getElementById("edit-mode");
        if (viewMode && editMode) {
            viewMode.style.display = "none";
            editMode.style.display = "block";
        }
    }

    function cancelEdit() {
        const viewMode = document.getElementById("view-mode");
        const editMode = document.getElementById("edit-mode");
        const pwInput = document.getElementById("edit-password-new");
        const saveBtn = document.getElementById("save-btn");

        if (viewMode && editMode) {
            editMode.style.display = "none";
            viewMode.style.display = "block";
        }

        if (pwInput) {
            pwInput.value = "";
            resetStyle(); 
        }
    }

    // 2. 실시간 감지 로직
    document.addEventListener("DOMContentLoaded", () => {
        const newPwInput = document.getElementById("edit-password-new");
        const warning = document.getElementById("pw-warning");
        const saveBtn = document.getElementById("save-btn");

        if (!newPwInput || !warning || !saveBtn) return;

        // [정상 상태] 기존 초록색 클래스 (remove용)
        // 혹시 작성자님 HTML에 ring-green-500 같은게 있다면 그것도 여기 적어주세요.
        const normalClasses = [
            "border-gray-300", 
            "focus:border-green-500"
        ];

        // [에러 상태] Tailwind 강제 적용(!) 클래스
        // 아까 1단계에서 투명 태그에 적어둔 것과 똑같아야 합니다.
        const errorClasses = [
            "!border-red-500",        // 강제 빨간 테두리
            "!focus:border-red-500",  // 클릭해도 강제 빨간 테두리
            "!focus:ring-red-500",    // 클릭 링도 강제 빨강
            "!text-red-900",          // 글자색 강제 빨강
            "!placeholder-red-300"    // 안내문구 강제 연빨강
        ];

        newPwInput.addEventListener("keyup", async () => {
            const typed = newPwInput.value;

            if (typed.length < 1) {
                resetStyle();
                return;
            }

            try {
                const tokenTag = document.querySelector('meta[name="csrf-token"]');
                const csrfToken = tokenTag ? tokenTag.getAttribute('content') : '';

                const response = await fetch("/check_password_match", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify({ password: typed })
                });

                if (!response.ok) throw new Error(`Error: ${response.status}`);
                const data = await response.json();

                if (data.match === true) {
                    showError(); 
                } else {
                    resetStyle(); 
                }

            } catch (error) {
                console.error("오류:", error);
            }
        });

        function showError() {
            newPwInput.classList.remove(...normalClasses);
            newPwInput.classList.add(...errorClasses);
            
            warning.style.display = "block";
            warning.classList.remove("hidden");
            
            saveBtn.disabled = true;
            saveBtn.style.opacity = "0.5";
            saveBtn.style.cursor = "not-allowed";
        }

        function resetStyle() {
            newPwInput.classList.remove(...errorClasses);
            newPwInput.classList.add(...normalClasses);
            
            warning.style.display = "none";
            warning.classList.add("hidden");
            
            saveBtn.disabled = false;
            saveBtn.style.opacity = "1";
            saveBtn.style.cursor = "pointer";
        }
    });
</script>
{% endblock %}