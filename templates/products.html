{%extends "layout.html"%}
{% block title %}상품 전체보기 | EWHA MARKET{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product_style.css') }}">
{% endblock %}

{% block content %}
<div class="products-page">
  <div class="title">상품 목록</div>

  <!-- 상품 카드 목록 -->
  <section class="grid">
    {% for p in datas %}
    <div class="card">
      <a href="{{ url_for('items.view_product', product_id=p.id, slug=p.name) }}">
        <div class="thumb" aria-label="상품 이미지" {% if p.img_path %}
          style="background-image:url('{{ url_for('static', filename='images/' ~ p.img_path) }}');" {% endif %}>
          <span class="heart wish-heart" data-id="{{ p.id }}">
            <i class="fa-regular fa-heart"></i>
          </span>
        </div>
        <div class="meta">
          <div class="name">{{ p.name }}</div>
          <div class="price">
            ₩{{ p.price }}
          </div>
        </div>
      </a>
    </div>
    {% else %}
    <p>표시할 상품이 없습니다.</p>
    {% endfor %}
  </section>
  <!-- 페이지네이션 -->
  <div class="pagination-section">
    <nav class="pagination" aria-label="pagination">
      {# 이전 버튼 #}
      {% if page > 1 %}
      <a href="{{ url_for('items.view_products', page=page-1) }}" class="page-num prev" aria-label="Previous">‹</a>
      {% else %}
      <span class="page-num prev disabled" aria-label="Previous">‹</span>
      {% endif %}

      {# 페이지 번호들 #}
      {% for p in range(1, page_count + 1) %}
      {% if p == page %}
      <span class="page-num active">{{ p }}</span>
      {% else %}
      <a href="{{ url_for('items.view_products', page=p) }}" class="page-num">{{ p }}</a>
      {% endif %}
      {% endfor %}


      {# 다음 버튼 #}
      {% if page < page_count %} <a href="{{ url_for('items.view_products', page=page+1) }}" class="page-num next"
        aria-label="Next">›</a>
        {% else %}
        <span class="page-num next disabled" aria-label="Next">›</span>
        {% endif %}

    </nav>
  </div>

</div>
{% endblock %}


{% block script %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ===== 0. localStorage에서 위시리스트 불러오기 ===== */
    let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');

    /* ===== 1. 하트 모양을 실제 상태에 맞게 그려주는 함수 ===== */
    function updateHeartVisual(heart) {
      const id = Number(heart.dataset.id);
      const icon = heart.querySelector('i');
      if (!icon) return;

      if (wishlist.includes(id)) {
        // 활성 상태 (초록색, 채워진 하트)
        heart.classList.add('active');
        icon.classList.remove('fa-regular');
        icon.classList.add('fa-solid');
      } else {
        // 비활성 상태 (회색, 빈 하트)
        heart.classList.remove('active');
        icon.classList.remove('fa-solid');
        icon.classList.add('fa-regular');
      }
    }

    /* ===== 2. 처음 로드될 때 모든 하트 상태 맞추기 ===== */
    document.querySelectorAll('.products-page .heart').forEach(heart => {
      updateHeartVisual(heart);
    });

    /* ===== 3. 하트 클릭 시 토글 (여러 개 전부 가능) ===== */
    const productsPage = document.querySelector('.products-page');
    if (productsPage) {
      productsPage.addEventListener('click', (e) => {
        const heart = e.target.closest('.heart');
        if (!heart) return;        // 하트를 누른 게 아니면 무시

        e.preventDefault();        // a 태그 이동 방지
        e.stopPropagation();

        const id = Number(heart.dataset.id);

        if (wishlist.includes(id)) {
          // 이미 위시에 있으면 → 제거
          wishlist = wishlist.filter(x => x !== id);
        } else {
          // 없으면 → 추가
          wishlist.push(id);
        }

        // 저장 & 비주얼 업데이트
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
        updateHeartVisual(heart);
      });
    }

</script>
{% endblock %}


