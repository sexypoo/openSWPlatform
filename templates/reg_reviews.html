{%extends "layout.html"%}
{% block title %}ë¦¬ë·° ì‘ì„± | EWHA MARKET{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/review_style.css') }}">
{% endblock %}

{% if review %}
  {% set form_action = url_for('reviews.update_review', review_id=review_id) %}
{% else %}
  {% set form_action = url_for('reviews.reg_review_submit_post') %}
{% endif %}

{%block content %}
<main class="review-reg-page">
    <h1 class="page-title">ë¦¬ë·° ì‘ì„±</h1>

    <form method="post" enctype="multipart/form-data" action="{{form_action}}">
    {{ form.hidden_tag() }} <!--CSRF í† í° ìë™ìœ¼ë¡œ ë„£ì–´ì£¼ê³ , Hidden field í•­ëª©ë“¤ ê°€ì ¸ì˜´-->
    <input type="hidden" name="item_id" value="{{ item_id or '' }}">
    <div class="section">
        <h2 class="section-title">ìƒí’ˆ ì •ë³´</h2>
        <div class="product-info">
            <div class="product-field">
                <label class="input-label" for="name">ìƒí’ˆëª…</label>
                <input type="text" class="text-input" id="pname" name="name"  value="{{ item.name if item else review.name }}" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
            </div>
            <div class="product-field">
                <label class="input-label" for="seller" value="{{ item.seller if item else review.seller }}">íŒë§¤ì</label>
                <input type="text" class="text-input" id="seller" name="seller"
                value="{{ item.seller if item and item.seller else (review.seller if review and review.seller else '') }}"
                placeholder="íŒë§¤ì ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="product-field">
                <label class="input-label" for="p_details">ìƒì„¸ ì •ë³´</label>
                <input type="text" class="text-input" id="p_details" name="p_details" value="{{ item.details if item else review.product_details }}"
                placeholder="ìƒì„¸ì •ë³´(ì˜µì…˜)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
            </div>
        </div>
    </div>

        <!-- ë³„ì  í‰ê°€ -->
        <div class="section rating-section">
            <h2 class="section-title">ë³„ì  í‰ê°€</h2>
            <div class="stars" id="starRating">
                <span class="star filled" data-value="1">â˜…</span>
                <span class="star" data-value="2">â˜…</span>
                <span class="star" data-value="3">â˜…</span>
                <span class="star" data-value="4">â˜…</span>
                <span class="star" data-value="5">â˜…</span>
            </div>
            <input type="hidden" id="rating" name="rating" value="{{ form.rating.data or (review.rating if review else 1) }}">
        </div>

        <!-- ë¦¬ë·° ë‚´ìš© -->
        <div class="section">
            <h2 class="section-title">ë¦¬ë·° ë‚´ìš©</h2>
            <div class="review-fields">
                <div class="field-group">
                    <label class="field-label" for="title">ì œëª©</label>
                    <input type="text" class="text-input" id="title" name="title" placeholder="ë¦¬ë·° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ form.title.data or (review.title if review else '') }}">
                </div>

                <div class="field-group">
                    <label class="field-label" for="r_details">ë‚´ìš©</label>
                    <textarea class="textarea-input large" id="r_details" name="r_details"
                        placeholder="ìƒí’ˆì— ëŒ€í•œ ì†”ì§í•œ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.">{{ form.r_details.data or (review.review_details if review else '') }}</textarea>
                </div>
            </div>
        </div>
        
        <!-- ì‚¬ì§„ ì²¨ë¶€ -->
        <div class="section">
            <h2 class="section-title">ì‚¬ì§„ ì²¨ë¶€</h2>
            <!-- ì‚¬ì§„ ì—…ë¡œë“œ ë²„íŠ¼ + ë¯¸ë¦¬ë³´ê¸° ê°€ë¡œ ë‚˜ì—´ -->
            <div class="photo-upload-section">
                <!-- ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ (ì •ì‚¬ê°í˜•, ì¹´ìš´íŠ¸ í¬í•¨) -->
                <button type="button" class="photo-upload-btn" onclick="document.getElementById('fileInput').click()">
                    <span class="upload-btn-text">ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°</span>
                    <span class="upload-count" id="uploadCount">0/3</span>
                </button>
                <input accept="image/*" id="fileInput" name="file" type="file" style="display: none;" multiple>
                <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
                <div id="photoPreview" class="photo-preview-container">
                    {% if review and review.images %}
                        {% for img in review.images %}
                            <div class="photo-preview-item existing" data-name="{{ img }}">
                                <img src="{{ img }}" class="preview-image">
                                <button type="button" class="delete-photo-btn">Ã—</button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ë¦¬ë·° ë“±ë¡ ë²„íŠ¼ -->
        <div class="section button-section">
            <button type="submit" class="back-button">ë¦¬ë·° ë“±ë¡</button>
        </div>
    </form>
</main>
{% endblock %}

{% block script %}
<script>
    // =======================
    // 1. ë³„ì  ê¸°ëŠ¥
    // =======================
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('rating');
    let currentRating = parseInt(ratingInput.value) || 1;

    updateStars();

    stars.forEach(star => {
        star.addEventListener('click', function () {
            currentRating = parseInt(this.getAttribute('data-value'));
            ratingInput.value = currentRating;
            updateStars();
        });

        star.addEventListener('mouseenter', function () {
            const value = parseInt(this.getAttribute('data-value'));
            stars.forEach((s, index) => {
                if (index < value) {
                    s.classList.add('filled');
                } else {
                    s.classList.remove('filled');
                }
            });
        });
    });

    document.getElementById('starRating').addEventListener('mouseleave', updateStars);

    function updateStars() {
        stars.forEach((star, index) => {
            if (index < currentRating) {
                star.classList.add('filled');
            } else {
                star.classList.remove('filled');
            }
        });
    }

    // =======================
    // 2. ì‚¬ì§„ ì—…ë¡œë“œ / ì‚­ì œ
    // =======================
    let selectedFiles = [];              // ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ë“¤
    const maxFiles = 3;
    const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif'];

    const existingImages = {{ (review.images if review and review.images else []) | tojson }};
    let existing = Array.isArray(existingImages) ? [...existingImages] : [];

    const fileInput        = document.getElementById('fileInput');
    const previewContainer = document.getElementById('photoPreview');
    const uploadCountEl    = document.getElementById('uploadCount');

    // ğŸ”¹ ê¸°ì¡´ì— ì„œë²„ì—ì„œ ë Œë”ëœ ì´ë¯¸ì§€ë“¤ (Jinjaê°€ ë§Œë“  div.existing)ì— X ë²„íŠ¼ ë™ì‘ ì—°ê²°
    function attachDeleteHandlersForExisting() {
        const items = previewContainer.querySelectorAll('.photo-preview-item.existing');

        items.forEach(item => {
            const btn = item.querySelector('.delete-photo-btn');
            if (!btn) return;

            btn.addEventListener('click', function () {
                const name = item.dataset.name;   // data-name ì— ë“¤ì–´ìˆëŠ” ì´ë¯¸ì§€ URL
                // existing ë°°ì—´ì—ì„œ ì œê±°
                existing = existing.filter(img => img !== name);
                // í™”ë©´ì—ì„œë„ ì œê±°
                item.remove();
                updateCount();
            });
        });
    }

    fileInput.addEventListener('change', function (e) {
        const files = Array.from(e.target.files);

        // ê¸°ì¡´ + ìƒˆ íŒŒì¼ í•©ì³ì„œ 3ì¥ì„ ë„˜ìœ¼ë©´ ì•ˆ ë¨
        if (selectedFiles.length + existing.length + files.length > maxFiles) {
            alert(`ìµœëŒ€ ${maxFiles}ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            return;
        }

        files.forEach(file => {
            const fileName = file.name;
            const fileExt  = fileName.split('.').pop().toLowerCase();

            if (!allowedExtensions.includes(fileExt)) {
                alert(`'${fileName}'ì€(ëŠ”) ì—…ë¡œë“œí•  ìˆ˜ ì—†ëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n(jpg, jpeg, png, gifë§Œ ê°€ëŠ¥)`);
                return;
            }

            if (selectedFiles.length + existing.length < maxFiles) {
                selectedFiles.push(file);
                displayPreview(file);
            }
        });

        updateCount();
    });

    function displayPreview(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
            const wrapper = document.createElement('div');
            wrapper.className = 'photo-preview-item';   // ìƒˆ íŒŒì¼ì€ existing í´ë˜ìŠ¤ ì—†ìŒ

            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'preview-image';

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'delete-photo-btn';
            deleteBtn.textContent = 'Ã—';

            // ğŸ”¹ ìƒˆë¡œ ì¶”ê°€í•œ íŒŒì¼ ì‚­ì œ ë¡œì§
            deleteBtn.addEventListener('click', function () {
                const index = selectedFiles.indexOf(file);
                if (index > -1) {
                    selectedFiles.splice(index, 1);
                }
                wrapper.remove();
                updateCount();
            });

            wrapper.appendChild(img);
            wrapper.appendChild(deleteBtn);
            previewContainer.appendChild(wrapper);
        };

        reader.readAsDataURL(file);
    }

    function updateCount() {
        if (!uploadCountEl) return;
        uploadCountEl.textContent = `${selectedFiles.length + existing.length}/${maxFiles}`;
    }

    // ğŸ”¹ í¼ submit ì‹œ, ë‚¨ì•„ ìˆëŠ” "ê¸°ì¡´ ì´ë¯¸ì§€ë“¤" ë¦¬ìŠ¤íŠ¸ë¥¼ hidden input ìœ¼ë¡œ ë³´ëƒ„
    document.querySelector('form').addEventListener('submit', function () {
        const input = document.createElement('input');
        input.type  = 'hidden';
        input.name  = 'existing_images';
        input.value = JSON.stringify(existing);
        this.appendChild(input);
        // selectedFiles ëŠ” fileInput ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ì „ì†¡ë¨
    });

    // í˜ì´ì§€ ì²˜ìŒ ë¡œë“œë  ë•Œ ê¸°ì¡´ ì´ë¯¸ì§€ X ë²„íŠ¼ í™œì„±í™” + ì¹´ìš´íŠ¸ ì„¸íŒ…
    attachDeleteHandlersForExisting();
    updateCount();
</script>
{% endblock %}
