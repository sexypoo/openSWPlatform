{%extends "layout.html"%}
{% block title %}ìƒí’ˆ ìˆ˜ì • | EWHA MARKET{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product_style.css') }}">
{% endblock %}

{%block content %}
<div class="reg-items-page">
    <div class="title">ìƒí’ˆ ìˆ˜ì •</div>
    <form method="POST" enctype="multipart/form-data"
          action="{{ url_for('products.edit_product', product_id=product_id, slug=slug) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="grid">

            <div>
                <label class="upload-card req-dot">
                    <small>ì‚¬ì§„</small>
                    <img alt="" class="preview" id="previewImg" hidden>
                    <div class="hint">í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
                    {{ form.files(
                        id="file",
                        multiple=True,
                        accept="image/*"
                    ) }}
                </label>

                <input type="hidden" id="existing_images_input" name="existing_images">
                <div id="photoPreview" class="photo-preview-container"></div>
            </div>
            <div>
                <div class="field">
                    <label class="req-dot" for="name">ìƒí’ˆëª…</label>
                    <input id="pname" name="name" required type="text" value="{{ product.name }}">
                </div>

                <div class="field">
                    <label class="req-dot" for="category">ì¹´í…Œê³ ë¦¬</label>
                    <select id="cate" name="category" required>
                        <option disabled value="">ì¹´í…Œê³ ë¦¬</option>
                        <option value="clothes" {% if product.category=='clothes' %}selected{% endif %}>ì˜ë¥˜</option>
                        <option value="book" {% if product.category=='book' %}selected{% endif %}>ì„œì </option>
                        <option value="fresh_produce" {% if product.category=='fresh_produce' %}selected{% endif %}>
                            ë†ìˆ˜ì‚°ë¬¼
                        </option>
                        <option value="eletronics" {% if product.category=='eletronics' %}selected{% endif %}>ì „ìê¸°ê¸°
                        </option>
                        <option value="service" {% if product.category=='service' %}selected{% endif %}>ì¼ê±°ë¦¬</option>
                        <option value="etc" {% if product.category=='etc' %}selected{% endif %}>ì¡í™”</option>
                    </select>
                </div>

                <div class="field">
                    <label class="req-dot" for="details">ì„¤ëª…</label>
                    <textarea id="details" name="details" required>{{ product.details }}</textarea>
                </div>

                <div class="field">
                    <label class="req-dot" for="quantity">ìˆ˜ëŸ‰</label>
                    <input type="number" name="quantity" id="quantity" min="1" required value="{{ product.quantity }}">
                </div>

                <div class="field">
                    <label for="tag">íƒœê·¸</label>
                    <input id="tag" name="tag" type="text" value="{{ product.tags }}">
                </div>

                <div class="field">
                    <label class="req-dot">ê°€ê²©</label>
                    <div class="price-row">
                        <input id="price" inputmode="numeric" name="price" required type="text"
                               value="{{ product.price }}">
                        <input disabled type="text" value="(ì›)">
                    </div>
                </div>

                <div class="field">
                    <label class="req-dot" id="label-method">ê±°ë˜ ë°©ë²•</label>
                    <div class="check-grid">
                        <label><input name="method" type="checkbox" value="ëŒ€ë©´ ì§ê±°ë˜ ê°€ëŠ¥"
                                      {% if "ëŒ€ë©´ ì§ê±°ë˜ ê°€ëŠ¥" in product.method %}checked{% endif %}>ëŒ€ë©´ ì§ê±°ë˜ ê°€ëŠ¥</label>

                        <label><input name="method" type="checkbox" value="ë¹„ëŒ€ë©´ ì§ê±°ë˜ ê°€ëŠ¥"
                                      {% if "ë¹„ëŒ€ë©´ ì§ê±°ë˜ ê°€ëŠ¥" in product.method %}checked{% endif %}>ë¹„ëŒ€ë©´ ì§ê±°ë˜ ê°€ëŠ¥</label>

                        <label><input name="method" type="checkbox" value="íƒë°° ê±°ë˜ ê°€ëŠ¥"
                                      {% if "íƒë°° ê±°ë˜ ê°€ëŠ¥" in product.method %}checked{% endif %}>íƒë°° ê±°ë˜ ê°€ëŠ¥</label>

                        <label><input name="method" type="checkbox" value="ê±°ë˜ ë°©ë²• ê°œì¸ ë¬¸ì˜ ìš”í•¨"
                                      {% if "ê±°ë˜ ë°©ë²• ê°œì¸ ë¬¸ì˜ ìš”í•¨" in product.method %}checked{% endif %}>ê±°ë˜ ë°©ë²• ê°œì¸ ë¬¸ì˜
                            ìš”í•¨</label>
                    </div>
                </div>

                <div class="submit-wrap">
                    <button class="btn" type="submit">ìƒí’ˆ ìˆ˜ì •</button>
                </div>
            </div>

        </div>
    </form>
</div>
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const fileInput    = document.getElementById("file");
    const previewImg   = document.getElementById("previewImg");
    const hint         = document.querySelector(".upload-card .hint");
    const previewStrip = document.getElementById("photoPreview");
    const existingInput = document.getElementById("existing_images_input");

    const maxFiles = 5;
    let newFiles = [];
    let currentObjectURL = null;

    // ğŸ”¹ ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ img_path (ë¦¬ìŠ¤íŠ¸ / JSONë¬¸ìì—´ / ë‹¨ì¼ë¬¸ìì—´ / null ëª¨ë‘ ì²˜ë¦¬)
    const imgPathRaw = {{ product.img_path|tojson|safe }};
    let existingImages = [];

    if (Array.isArray(imgPathRaw)) {
        existingImages = imgPathRaw.filter(Boolean);
    } else if (typeof imgPathRaw === "string" && imgPathRaw.trim() !== "") {
        const trimmed = imgPathRaw.trim();
        if (trimmed.startsWith("[") && trimmed.endsWith("]")) {
            try {
                const parsed = JSON.parse(trimmed);
                if (Array.isArray(parsed)) {
                    existingImages = parsed.filter(Boolean);
                } else {
                    existingImages = [imgPathRaw];
                }
            } catch (e) {
                existingImages = [imgPathRaw];
            }
        } else {
            existingImages = [imgPathRaw];
        }
    } else {
        existingImages = [];
    }

    function syncExistingInput() {
        if (existingInput) {
            existingInput.value = JSON.stringify(existingImages);
        }
    }

    function renderPreviews() {
        previewStrip.innerHTML = "";

        // 1) ê¸°ì¡´ ì´ë¯¸ì§€ ì¸ë„¤ì¼
        existingImages.forEach((url, index) => {
            if (!url) return;
            const wrapper = document.createElement("div");
            wrapper.className = "photo-preview-item existing";

            const img = document.createElement("img");
            img.src = url;
            img.className = "preview-image";

            img.addEventListener("click", () => {
                previewImg.src = url;
                previewImg.hidden = false;
                if (hint) hint.style.display = "none";
            });

            const removeBtn = document.createElement("div");
            removeBtn.className = "remove-btn";
            removeBtn.textContent = "Ã—";

            removeBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                existingImages.splice(index, 1);
                renderPreviews();
            });

            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            previewStrip.appendChild(wrapper);
        });

        // 2) ìƒˆë¡œ ì¶”ê°€í•œ íŒŒì¼ ì¸ë„¤ì¼
        newFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wrapper = document.createElement("div");
                wrapper.className = "photo-preview-item";

                const img = document.createElement("img");
                img.src = e.target.result;
                img.className = "preview-image";

                img.addEventListener("click", () => {
                    previewImg.src = e.target.result;
                    previewImg.hidden = false;
                    if (hint) hint.style.display = "none";
                });

                const removeBtn = document.createElement("div");
                removeBtn.className = "remove-btn";
                removeBtn.textContent = "Ã—";

                removeBtn.addEventListener("click", (ev) => {
                    ev.stopPropagation();
                    newFiles.splice(index, 1);

                    // fileInput.filesë„ ë‹¤ì‹œ ì„¸íŒ…
                    const dt = new DataTransfer();
                    newFiles.forEach(f => dt.items.add(f));
                    fileInput.files = dt.files;

                    renderPreviews();
                });

                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                previewStrip.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });

        // 3) ë©”ì¸ í° í”„ë¦¬ë·° í•œ ì¥
        if (existingImages.length > 0) {
            previewImg.src = existingImages[0];
            previewImg.hidden = false;
            if (hint) hint.style.display = "none";
        } else if (newFiles.length > 0) {
            if (currentObjectURL) {
                URL.revokeObjectURL(currentObjectURL);
            }
            const url = URL.createObjectURL(newFiles[0]);
            currentObjectURL = url;
            previewImg.src = url;
            previewImg.hidden = false;
            if (hint) hint.style.display = "none";
        } else {
            // ì•„ë¬´ê²ƒë„ ì—†ì„ ë•Œ
            previewImg.hidden = true;
            previewImg.removeAttribute("src");
            if (hint) hint.style.display = "";
        }

        // ğŸ”¹ hidden input ê°’ ë™ê¸°í™” (ì‚­ì œ/ì¶”ê°€ í›„ í•­ìƒ)
        syncExistingInput();
    }

    // ì´ˆê¸° ë Œë”(ê¸°ì¡´ ì´ë¯¸ì§€ ìˆì„ ê²½ìš°)
    renderPreviews();

    // ğŸ”¹ ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ
    fileInput.addEventListener("change", () => {
        const newlySelected = Array.from(fileInput.files || []);
        const allowedExt = ["jpg", "jpeg", "png", "gif"];

        for (const f of newlySelected) {
            const ext = f.name.split(".").pop().toLowerCase();
            if (!allowedExt.includes(ext)) {
                alert("í—ˆìš©ëœ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤ (jpg, jpeg, png, gif)");
                fileInput.value = "";
                return;
            }
            if (!f.type.startsWith("image/")) {
                alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                fileInput.value = "";
                return;
            }
        }

        if (newFiles.length + newlySelected.length > maxFiles) {
            alert(`ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” íŒŒì¼ì€ ìµœëŒ€ ${maxFiles}ì¥ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n(í˜„ì¬ ìƒˆ íŒŒì¼: ${newFiles.length}ì¥)`);
            fileInput.value = "";
            return;
        }

        newFiles = newFiles.concat(newlySelected);

        const dt = new DataTransfer();
        newFiles.forEach(f => dt.items.add(f));
        fileInput.files = dt.files;

        renderPreviews();
    });
});

// â¬‡ ê¸°ì¡´ tagInput ê´€ë ¨ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€
document.addEventListener("DOMContentLoaded", function () {
    const tagInput = document.getElementById("tag");
    if (!tagInput) return;
    tagInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
        }
    });
    tagInput.addEventListener("focus", function () {
        if (tagInput.value.trim() === "") {
            tagInput.value = "#";
            tagInput.setSelectionRange(tagInput.value.length, tagInput.value.length);
        }
    });
    tagInput.addEventListener("input", function () {
        let v = tagInput.value;
        if (!v.endsWith(" ")) return;
        let tokens = v.trim().split(/\s+/).filter(Boolean);
        tokens = tokens.map(t => t.startsWith("#") ? t : "#" + t);
        tagInput.value = tokens.join(" ") + " ";
        tagInput.setSelectionRange(tagInput.value.length, tagInput.value.length);
    });
});
</script>
{% endblock %}
