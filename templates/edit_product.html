{%extends "layout.html"%}
{% block title %}상품 수정 | EWHA MARKET{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product_style.css') }}">
{% endblock %}

{%block content %}
<div class="reg-items-page">
    <div class="title">상품 수정</div>
    <form method="POST" enctype="multipart/form-data"
          action="{{ url_for('products.edit_product', product_id=product_id, slug=slug) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="grid">

            <div>
                <label class="upload-card req-dot">
                    <small>사진</small>
                    <img alt="" class="preview" id="previewImg" hidden>
                    <div class="hint">클릭하여 파일을 선택하세요</div>
                    <input type="file" id="file" name="file" accept="image/*" style="display: none">
                </label>

                <input type="hidden" id="existing_images_input" name="existing_images">
                <div id="photoPreview" class="photo-preview-container"></div>
            </div>
            <div>
                <div class="field">
                    <label class="req-dot" for="name">상품명</label>
                    <input id="pname" name="name" required type="text" value="{{ product.name }}">
                </div>

                <div class="field">
                    <label class="req-dot" for="category">카테고리</label>
                    <select id="cate" name="category" required>
                        <option disabled value="">카테고리</option>
                        <option value="clothes" {% if product.category=='clothes' %}selected{% endif %}>의류</option>
                        <option value="book" {% if product.category=='book' %}selected{% endif %}>서적</option>
                        <option value="fresh_produce" {% if product.category=='fresh_produce' %}selected{% endif %}>
                            농수산물
                        </option>
                        <option value="eletronics" {% if product.category=='eletronics' %}selected{% endif %}>전자기기
                        </option>
                        <option value="service" {% if product.category=='service' %}selected{% endif %}>일거리</option>
                        <option value="etc" {% if product.category=='etc' %}selected{% endif %}>잡화</option>
                    </select>
                </div>

                <div class="field">
                    <label class="req-dot" for="details">설명</label>
                    <textarea id="details" name="details" required>{{ product.details }}</textarea>
                </div>

                <div class="field">
                    <label class="req-dot" for="quantity">수량</label>
                    <div class="quantity-row">
                    <input type="number" name="quantity" id="quantity" min="1" required value="{{ product.quantity }}">
                    </div>
                </div>

                <div class="field">
                    <label for="tag">태그</label>
                    <input id="tag" name="tag" type="text" value="{{ product.tags }}">
                </div>

                <div class="field">
                    <label class="req-dot">가격</label>
                    <div class="price-row">
                        <input id="price" inputmode="numeric" name="price" required type="text"
                               value="{{ product.price }}">
                        <input disabled type="text" value="(원)">
                    </div>
                </div>

                <div class="field">
                    <label class="req-dot" id="label-method">거래 방법</label>
                    <div class="check-grid">
                        <label><input name="method" type="checkbox" value="대면 직거래 가능"
                                      {% if "대면 직거래 가능" in product.method %}checked{% endif %}>대면 직거래 가능</label>

                        <label><input name="method" type="checkbox" value="비대면 직거래 가능"
                                      {% if "비대면 직거래 가능" in product.method %}checked{% endif %}>비대면 직거래 가능</label>

                        <label><input name="method" type="checkbox" value="택배 거래 가능"
                                      {% if "택배 거래 가능" in product.method %}checked{% endif %}>택배 거래 가능</label>

                        <label><input name="method" type="checkbox" value="거래 방법 개인 문의 요함"
                                      {% if "거래 방법 개인 문의 요함" in product.method %}checked{% endif %}>거래 방법 개인 문의
                            요함</label>
                    </div>
                </div>

                <div class="submit-wrap">
                    <button class="btn" type="submit">상품 수정</button>
                </div>
            </div>

        </div>
    </form>
</div>
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    /* -----------------------------------------------------------
       공통 변수
    ----------------------------------------------------------- */
    const fileInput    = document.getElementById("file");
    const previewImg   = document.getElementById("previewImg");
    const hint         = document.querySelector(".upload-card .hint");
    const previewStrip = document.getElementById("photoPreview");
    const existingInput = document.getElementById("existing_images_input");
    const maxFiles = 5;

    let newFiles = [];
    let existingImages = [];
    let currentObjectURL = null;

    /* -----------------------------------------------------------
       기존 이미지 로드 (서버에서 넘어온 product.img_path)
    ----------------------------------------------------------- */
    const raw = {{ product.img_path|tojson|safe }};
    if (Array.isArray(raw)) {
        existingImages = raw.filter(Boolean);
    } else if (typeof raw === "string" && raw.trim() !== "") {
        const trimmed = raw.trim();
        if (trimmed.startsWith("[") && trimmed.endsWith("]")) {
            try {
                const parsed = JSON.parse(trimmed);
                if (Array.isArray(parsed)) existingImages = parsed.filter(Boolean);
            } catch (_) {
                existingImages = [raw];
            }
        } else {
            existingImages = [raw];
        }
    }

    // 다른 스크립트에서도 보이도록 전역 등록
    window._existingImages = existingImages;

    /* -----------------------------------------------------------
       existing_images hidden input 동기화
    ----------------------------------------------------------- */
    function syncExistingInput() {
        existingInput.value = JSON.stringify(existingImages);
    }

    /* -----------------------------------------------------------
       프리뷰 렌더 함수
    ----------------------------------------------------------- */
    function renderPreviews() {
        previewStrip.innerHTML = "";

        /* --- 기존 이미지 썸네일 --- */
        existingImages.forEach((url, index) => {
            const wrap = document.createElement("div");
            wrap.className = "photo-preview-item existing";

            const img = document.createElement("img");
            img.src = url;
            img.className = "preview-image";

            img.addEventListener("click", () => {
                previewImg.src = url;
                previewImg.hidden = false;
                hint.style.display = "none";
            });

            const removeBtn = document.createElement("div");
            removeBtn.className = "remove-btn";
            removeBtn.textContent = "×";

            removeBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                existingImages.splice(index, 1);  // 삭제
                window._existingImages = existingImages;
                syncExistingInput();
                renderPreviews();
                triggerRequiredCheck();
            });

            wrap.appendChild(img);
            wrap.appendChild(removeBtn);
            previewStrip.appendChild(wrap);
        });

        /* --- 새 파일 이미지 썸네일 --- */
        newFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const wrap = document.createElement("div");
                wrap.className = "photo-preview-item";

                const img = document.createElement("img");
                img.src = ev.target.result;
                img.className = "preview-image";

                img.addEventListener("click", () => {
                    previewImg.src = ev.target.result;
                    previewImg.hidden = false;
                    hint.style.display = "none";
                });

                const removeBtn = document.createElement("div");
                removeBtn.className = "remove-btn";
                removeBtn.textContent = "×";

                removeBtn.addEventListener("click", (ev2) => {
                    ev2.stopPropagation();
                    newFiles.splice(index, 1);

                    const dt = new DataTransfer();
                    newFiles.forEach(f => dt.items.add(f));
                    fileInput.files = dt.files;

                    renderPreviews();
                    triggerRequiredCheck();
                });

                wrap.appendChild(img);
                wrap.appendChild(removeBtn);
                previewStrip.appendChild(wrap);
            };
            reader.readAsDataURL(file);
        });

        /* --- 큰 프리뷰 업데이트 --- */
        if (existingImages.length > 0) {
            previewImg.src = existingImages[0];
            previewImg.hidden = false;
            hint.style.display = "none";
        } else if (newFiles.length > 0) {
            if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
            const url = URL.createObjectURL(newFiles[0]);
            currentObjectURL = url;
            previewImg.src = url;
            previewImg.hidden = false;
            hint.style.display = "none";
        } else {
            previewImg.hidden = true;
            previewImg.removeAttribute("src");
            hint.style.display = "";
        }

        syncExistingInput();
    }

    /* -----------------------------------------------------------
       파일 선택 이벤트
    ----------------------------------------------------------- */
    fileInput.addEventListener("change", () => {
        const selected = Array.from(fileInput.files || []);
        const allowedExt = ["jpg", "jpeg", "png", "gif"];

        // 확장자, 타입 검사
        for (const f of selected) {
            const ext = f.name.split(".").pop().toLowerCase();
            if (!allowedExt.includes(ext) || !f.type.startsWith("image/")) {
                alert("이미지 파일(jpg, jpeg, png, gif)만 업로드 가능합니다.");
                fileInput.value = "";
                return;
            }
        }

        // 5장 제한 검사
        if (newFiles.length + selected.length > maxFiles) {
            alert(`최대 ${maxFiles}장까지 업로드 가능합니다.`);
            fileInput.value = "";
            return;
        }

        newFiles = newFiles.concat(selected);

        // input.files 동기화
        const dt = new DataTransfer();
        newFiles.forEach(f => dt.items.add(f));
        fileInput.files = dt.files;

        renderPreviews();
        triggerRequiredCheck();
    });

    /* -----------------------------------------------------------
       태그 입력 처리
    ----------------------------------------------------------- */
    const tagInput = document.getElementById("tag");
    if (tagInput) {
        tagInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") e.preventDefault();
        });
        tagInput.addEventListener("focus", () => {
            if (tagInput.value.trim() === "") tagInput.value = "#";
        });
        tagInput.addEventListener("input", () => {
            const v = tagInput.value;
            if (v.endsWith(" ")) {
                let tokens = v.trim().split(/\s+/).filter(Boolean)
                    .map(t => t.startsWith("#") ? t : "#" + t);
                tagInput.value = tokens.join(" ") + " ";
            }
        });
    }

    /* -----------------------------------------------------------
       필수 항목 체크
    ----------------------------------------------------------- */
    const form = document.querySelector("form");
    const requiredFields = form.querySelectorAll("input[required], textarea[required], select[required]");
    const checkboxes = form.querySelectorAll("input[type='checkbox'][name='method']");
    const submitButton = form.querySelector(".btn");
    const uploadLabel = fileInput.closest(".upload-card");
    const methodLabel = document.getElementById("label-method");

    function showDot(el, visible) {
        if (el) el.style.setProperty("--show-dot", visible ? "visible" : "hidden");
    }

    function checkRequired() {
        let allFilled = true;

        // 텍스트/textarea/select 검사
        requiredFields.forEach(field => {
            const label = field.closest(".field")?.querySelector(".req-dot");
            if (field.value.trim() === "") {
                showDot(label, true);
                allFilled = false;
            } else showDot(label, false);
        });

        // 이미지 검사 (기존 + 새 파일 중 1장 이상)
        const hasAnyImage =
            (window._existingImages && window._existingImages.length > 0) ||
            fileInput.files.length > 0;

        if (!hasAnyImage) {
            showDot(uploadLabel, true);
            allFilled = false;
        } else {
            showDot(uploadLabel, false);
        }

        // 체크박스 검사
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        if (!anyChecked) {
            showDot(methodLabel, true);
            allFilled = false;
        } else {
            showDot(methodLabel, false);
        }

        submitButton.disabled = !allFilled;
    }

    function triggerRequiredCheck() {
        const event = new Event("input", { bubbles: true });
        fileInput.dispatchEvent(event);
    }

    // 모든 요소 변화 감지
    [...requiredFields, ...checkboxes].forEach(el => {
        el.addEventListener("input", checkRequired);
        el.addEventListener("change", checkRequired);
    });
    fileInput.addEventListener("input", checkRequired);

    // 초기 로딩
    renderPreviews();
    checkRequired();
});
</script>
{% endblock %}
