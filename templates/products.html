{%extends "layout.html"%}
{% block title %}상품 전체보기 | EWHA MARKET{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product_style.css') }}">
{% endblock %}

{% block content %}
<div class="products-page">
  <div class="title">상품 전체 조회</div>
  <p class="products-subtitle">총 {{ total }}개의 상품</p>

  {% if tag %}
  <div class="tag-filter-banner">
    <span class="tag-chip-big">#{{ tag }}</span>
  </div>
{% endif %}
 <form method="get" class="category-search-bar">
  <select id="category" name="category" class="category-select">
    <option value="">전체</option>
    <option value="clothes" {% if category == 'clothes' %}selected{% endif %}>의류</option>
    <option value="book" {% if category == 'book' %}selected{% endif %}>서적</option>
    <option value="fresh_produce" {% if category == 'fresh_produce' %}selected{% endif %}>농수산물</option>
    <option value="eletronics" {% if category == 'eletronics' %}selected{% endif %}>전자기기</option>
    <option value="service" {% if category == 'service' %}selected{% endif %}>일거리</option>
    <option value="etc" {% if category == 'etc' %}selected{% endif %}>잡화</option>
  </select>

  <button type="submit" class="category-btn">검색</button>

  {% if tag %}
    <span class="tag-chip">#{{ tag }}
      <a href="{{ url_for('products.view_products', category=category) }}" class="tag-chip-x">x</a>
    </span>
  {% endif %}
</form>

  <!-- 상품 카드 목록 -->
  <section class="grid">
    {% for p in datas %}
    <div class="card">
      <a href="{{ url_for('products.view_product', product_id=p.id, slug=p.name) }}">
        <div class="thumb {% if p.quantity == 0 %}soldout-thumb{% endif %}" aria-label="상품 이미지" {% if p.img_path %}
          style="background-image:url('{{ url_for('static', filename='images/' ~ p.img_path) }}');" {% endif %}>
          <span class="heart wish-heart" data-id="{{ p.id }}">
            <i class="fa-regular fa-heart"></i>
          </span>
        </div>
        {% if p.quantity == 0 %}
        <div class="soldout-badge">품절</div>
        {% endif %}
        <div class="name">{{ p.name }}</div>
        <div class="price">
          ₩{{ p.price }}
        </div>
      </a>
    </div>
    {% else %}
    <p>표시할 상품이 없습니다.</p>
    {% endfor %}
  </section>
  <!-- 페이지네이션 -->
  <div class="pagination-section">
    <nav class="pagination" aria-label="pagination">
      {# 이전 버튼 #}
      {% if page > 1 %}
      <a href="{{ url_for('products.view_products', page=page-1, category=category, tag=tag) }}" class="page-num prev" aria-label="Previous">‹</a>
      {% else %}
      <span class="page-num prev disabled" aria-label="Previous">‹</span>
      {% endif %}

      {# 페이지 번호들 #}
      {% for p in range(1, page_count + 1) %}
      {% if p == page %}
      <span class="page-num active">{{ p }}</span>
      {% else %}
      <a href="{{ url_for('products.view_products', page=p, category=category, tag=tag) }}" class="page-num">{{ p }}</a>
      {% endif %}
      {% endfor %}


      {# 다음 버튼 #}
      {% if page < page_count %} <a href="{{ url_for('products.view_products', page=page+1, category=category) }}" class="page-num next"
        aria-label="Next">›</a>
        {% else %}
        <span class="page-num next disabled" aria-label="Next">›</span>
        {% endif %}

    </nav>
  </div>

</div>
{% endblock %}


{% block script %}
<script>

  document.addEventListener('DOMContentLoaded', () => {
    function getCsrfToken() {
      const meta = document.querySelector('meta[name="csrf-token"]');
      return meta ? meta.getAttribute('content') : '';
    }

    let wishlist = [];   // 이제 localStorage 대신 서버에서 받아오기

    function updateHeartVisual(heart) {
      const id = heart.dataset.id;   // 문자열로 다루자
      const icon = heart.querySelector('i');
      if (!icon) return;

      if (wishlist.includes(id)) {
        heart.classList.add('active');
        icon.classList.remove('fa-regular');
        icon.classList.add('fa-solid');
      } else {
        heart.classList.remove('active');
        icon.classList.remove('fa-solid');
        icon.classList.add('fa-regular');
      }
    }


    // 1) 페이지 로드 시, 내 위시 목록 먼저 불러오기
    fetch('{{ url_for("wish.my_hearts") }}')
      .then(res => res.json())
      .then(data => {
        wishlist = (data.hearts || []).map(String);  // 문자열 배열로 맞추기

        document.querySelectorAll('.products-page .heart').forEach(heart => {
          updateHeartVisual(heart);
        });
      });

    // 2) 하트 클릭 시, 백엔드에 like/unlike 요청
    const productsPage = document.querySelector('.products-page');
    if (productsPage) {
      productsPage.addEventListener('click', (e) => {
        const heart = e.target.closest('.heart');
        if (!heart) return;

        e.preventDefault();
        e.stopPropagation();

        const id = heart.dataset.id;

        const isWish = wishlist.includes(id);
        const url = isWish
          ? `{{ url_for("wish.unlike", id="__ID__") }}`.replace('__ID__', id)
          : `{{ url_for("wish.like", id="__ID__") }}`.replace('__ID__', id);

        fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        })
          .then(res => {
            if (!res.ok) {
              return res.text().then(text => {
                console.error('Wish API error:', text);
                throw new Error('Wish API failed');
              });
            }
            return res.json();
          })
          .then(data => {
            // 로컬 배열 업데이트
            if (isWish) {
              wishlist = wishlist.filter(x => x !== id);
            } else {
              wishlist.push(id);
            }
            updateHeartVisual(heart);
          })
          .catch(err => {
            console.error(err);
          });
      });
    }
  });
</script>
{% endblock %}
